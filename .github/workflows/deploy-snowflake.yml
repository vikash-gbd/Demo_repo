name: Deploy to Snowflake using Liquibase

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      LIQUIBASE_HOME: /usr/local/liquibase
      LIQUIBASE_PROPS_FILE: ./liquibase.properties

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: 17

      - name: Download and install Liquibase
        run: |
          curl -Lo liquibase.tar.gz https://github.com/liquibase/liquibase/releases/download/v4.25.1/liquibase-4.25.1.tar.gz
          tar -xzf liquibase.tar.gz
          sudo mv liquibase /usr/local/liquibase
          sudo ln -sf /usr/local/liquibase/liquibase /usr/local/bin/liquibase

      - name: Download Snowflake JDBC driver
        run: |
          mkdir -p liquibase-cli/internal/lib
          curl -Lo liquibase-cli/internal/lib/snowflake-jdbc.jar https://repo1.maven.org/maven2/net/snowflake/snowflake-jdbc/3.13.30/snowflake-jdbc-3.13.30.jar

      - name: Configure Liquibase properties
        run: |
          echo "driver=net.snowflake.client.jdbc.SnowflakeDriver" > liquibase.properties
          echo "url=jdbc:snowflake://${{ secrets.SNOWFLAKE_URL }}?warehouse=DEMO_WH&db=DEMO_DB&schema=DEMO_SCHEMA&role=ACCOUNTADMIN" >> liquibase.properties
          echo "username=${{ secrets.SNOWFLAKE_USER }}" >> liquibase.properties
          echo "password=${{ secrets.SNOWFLAKE_PASSWORD }}" >> liquibase.properties
          echo "changeLogFile=liquibase/changelog/liquibase-master.xml" >> liquibase.properties
          echo "classpath=liquibase-cli/internal/lib/snowflake-jdbc.jar" >> liquibase.properties

      - name: Verify Liquibase installation
        run: |
          liquibase --version

      - name: Run Liquibase
        run: |
          if [ ! -f ".liquibase-synced" ]; then
            echo "First-time run: Running updateSQL (dry-run) and changelogSync..."
            liquibase updateSQL
            liquibase changelogSync
            touch .liquibase-synced
            git config --global user.email "actions@github.com"
            git config --global user.name "GitHub Actions"
            git add .liquibase-synced
            git commit -m "Mark Liquibase changelog as synced"
            git push
          else
            echo "Subsequent run: Applying actual changes..."
            liquibase update
          fi
