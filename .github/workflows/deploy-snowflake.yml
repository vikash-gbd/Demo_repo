name: Deploy to Snowflake via Liquibase

on:
  push:
    branches:
      - main
      - feature/**

jobs:
  liquibase-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          java-version: '17'

      - name: Download Liquibase
        run: |
          curl -L https://github.com/liquibase/liquibase/releases/download/v4.27.0/liquibase-4.27.0.tar.gz | tar xz
          mkdir -p liquibase-cli/internal/lib
          mv liquibase liquibase-cli/

      - name: Download Snowflake JDBC Driver
        run: |
          curl -L -o liquibase-cli/internal/lib/snowflake-jdbc.jar https://repo1.maven.org/maven2/net/snowflake/snowflake-jdbc/3.13.30/snowflake-jdbc-3.13.30.jar

      - name: Run Liquibase updateSQL and changelogSync on first run
        if: github.ref == 'refs/heads/main' && github.event.before == '0000000000000000000000000000000000000000'
        run: |
          liquibase-cli/liquibase \
            --defaults-file=liquibase.properties \
            --username=${{ secrets.SNOWFLAKE_USER }} \
            --password=${{ secrets.SNOWFLAKE_PASSWORD }} \
            updateSql > dry-run.sql

          liquibase-cli/liquibase \
            --defaults-file=liquibase.properties \
            --username=${{ secrets.SNOWFLAKE_USER }} \
            --password=${{ secrets.SNOWFLAKE_PASSWORD }} \
            changelogSync

      - name: Run Liquibase update (for future commits)
        if: github.ref == 'refs/heads/main' && github.event.before != '0000000000000000000000000000000000000000'
        run: |
          liquibase-cli/liquibase \
            --defaults-file=liquibase.properties \
            --username=${{ secrets.SNOWFLAKE_USER }} \
            --password=${{ secrets.SNOWFLAKE_PASSWORD }} \
            update
