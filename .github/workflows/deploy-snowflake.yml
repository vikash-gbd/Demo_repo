name: Deploy to Snowflake via Liquibase

on:
  push:
    branches:
      - main

jobs:
  liquibase-deploy:
    runs-on: ubuntu-latest

    env:
      SF_USER: Ravisingh9471
      SF_PASSWORD: Ravisingh_9471
      SF_URL: EQNVJAL-AJB41054.snowflakecomputing.com
      SF_ROLE: ACCOUNTADMIN
      SF_WAREHOUSE: COMPUTE_WH
      SF_DATABASE: DEMO_DB
      SF_SCHEMA: DEMO_SCHEMA

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up Java 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Download and Extract Liquibase CLI
        run: |
          set -e
          mkdir -p liquibase-cli
          curl -L -o liquibase.tar.gz https://github.com/liquibase/liquibase/releases/download/v4.24.0/liquibase-4.24.0.tar.gz
          tar -xzf liquibase.tar.gz -C liquibase-cli --strip-components=1
          chmod +x liquibase-cli/liquibase
          rm liquibase.tar.gz

      - name: Detect First Commit
        id: detect
        run: |
          if [ "${{ github.event.before }}" == "0000000000000000000000000000000000000000" ]; then
            echo "cmd=updateSql && liquibase-cli/liquibase changelogSync" >> $GITHUB_OUTPUT
          else
            echo "cmd=update" >> $GITHUB_OUTPUT
          fi

      - name: Run Liquibase
        run: |
          echo "Running Liquibase Command: ${{ steps.detect.outputs.cmd }}"
          if [[ "${{ steps.detect.outputs.cmd }}" == updateSql* ]]; then
            liquibase-cli/liquibase updateSql
            liquibase-cli/liquibase changelogSync
          else
            liquibase-cli/liquibase update
          fi
