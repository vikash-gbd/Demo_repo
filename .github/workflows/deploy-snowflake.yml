name: Deploy to Snowflake via Liquibase

on:
  push:
    branches:
      - main

jobs:
  liquibase-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up Java 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Download and Extract Liquibase CLI
        run: |
          rm -rf liquibase-cli liquibase.tar.gz liquibase-4.24.0
          curl -sL https://github.com/liquibase/liquibase/releases/download/v4.24.0/liquibase-4.24.0.tar.gz -o liquibase.tar.gz
          tar -xzf liquibase.tar.gz
          mkdir -p liquibase-cli
          mv liquibase-4.24.0/* liquibase-cli/
          chmod +x liquibase-cli/bin/liquibase
          rm -rf liquibase.tar.gz liquibase-4.24.0

      - name: Set Liquibase Command (first-time dry run or real update)
        id: check-history
        run: |
          if git rev-list --count HEAD | grep -q '^1$'; then
            echo "cmd=updateSql" >> $GITHUB_OUTPUT
          else
            echo "cmd=update" >> $GITHUB_OUTPUT
          fi

      - name: Run Liquibase
        run: |
          ./liquibase-cli/bin/liquibase \
            --defaultsFile=liquibase.properties \
            ${{ steps.check-history.outputs.cmd }}
        env:
          LIQUIBASE_COMMAND_USERNAME: ${{ secrets.SF_USER }}
          LIQUIBASE_COMMAND_PASSWORD: ${{ secrets.SF_PASSWORD }}
          SF_URL: ${{ secrets.SF_URL }}
          SF_ROLE: ${{ secrets.SF_ROLE }}
          SF_WAREHOUSE: ${{ secrets.SF_WAREHOUSE }}
          SF_DATABASE: ${{ secrets.SF_DATABASE }}
          SF_SCHEMA: ${{ secrets.SF_SCHEMA }}
