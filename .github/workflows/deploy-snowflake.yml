name: Deploy to Snowflake via Liquibase

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: 17
          java-package: jdk

      - name: Set up Liquibase
        run: |
          rm -rf liquibase
          curl -Lo liquibase.tar.gz https://github.com/liquibase/liquibase/releases/download/v4.25.1/liquibase-4.25.1.tar.gz
          tar -xzf liquibase.tar.gz
          sudo mv liquibase /usr/local/bin/liquibase

      - name: Download Snowflake JDBC Driver
        run: |
          mkdir -p liquibase-cli/internal/lib
          curl -Lo liquibase-cli/internal/lib/snowflake-jdbc.jar https://repo1.maven.org/maven2/net/snowflake/snowflake-jdbc/3.13.29/snowflake-jdbc-3.13.29.jar

      - name: Generate SQL output (Dry Run)
        run: |
          liquibase \
            --defaults-file=liquibase.properties \
            updateSql > dryrun.sql

      - name: Changelog Sync (mark as executed)
        run: |
          liquibase \
            --defaults-file=liquibase.properties \
            changelogSync
        if: github.run_number == 1  # Only for first commit

      - name: Apply Changes (from 2nd commit onwards)
        run: |
          liquibase \
            --defaults-file=liquibase.properties \
            update
        if: github.run_number != 1
