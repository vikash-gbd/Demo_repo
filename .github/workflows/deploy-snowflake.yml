name: Deploy to Snowflake via Liquibase

on:
  push:
    branches:
      - main

jobs:
  liquibase-deploy:
    runs-on: ubuntu-latest

    env:
      SF_USER:       ${{ secrets.SF_USER }}
      SF_PASSWORD:   ${{ secrets.SF_PASSWORD }}
      SF_URL:        ${{ secrets.SF_URL }}
      SF_ROLE:       ${{ secrets.SF_ROLE }}
      SF_WAREHOUSE:  ${{ secrets.SF_WAREHOUSE }}
      SF_DATABASE:   ${{ secrets.SF_DATABASE }}
      SF_SCHEMA:     ${{ secrets.SF_SCHEMA }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17

      - name: Download & Extract Liquibase CLI
        run: |
          rm -rf liquibase-cli liquibase.tar.gz
          curl -sL https://github.com/liquibase/liquibase/releases/download/v4.24.0/liquibase-4.24.0.tar.gz \
            -o liquibase.tar.gz

          mkdir -p liquibase-cli

          if tar -tf liquibase.tar.gz | grep -q 'liquibase-4.24.0/bin/liquibase'; then
            tar -xzf liquibase.tar.gz -C liquibase-cli --strip-components=2 liquibase-4.24.0/bin
          elif tar -tf liquibase.tar.gz | grep -q 'liquibase-4.24.0/liquibase/liquibase'; then
            tar -xzf liquibase.tar.gz -C liquibase-cli --strip-components=2 liquibase-4.24.0/liquibase
          else
            echo "❌ Liquibase binary not found in archive!"
            exit 1
          fi

          chmod +x liquibase-cli/liquibase
          rm liquibase.tar.gz

      - name: Decide Dry‑Run or Update
        id: choose
        run: |
          if [ "${{ github.event.before }}" = "0000000000000000000000000000000000000000" ]; then
            echo "cmd=updateSql && liquibase-cli/liquibase changelogSync" >> $GITHUB_OUTPUT
          else
            echo "cmd=update" >> $GITHUB_OUTPUT
          fi

      - name: Run Liquibase
        run: |
          echo "Running Liquibase command: ${{ steps.choose.outputs.cmd }}"
          eval "./liquibase-cli/liquibase --defaultsFile=liquibase.properties ${{ steps.choose.outputs.cmd }}"
