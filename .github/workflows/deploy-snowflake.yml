name: Deploy to Snowflake using Liquibase

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      LIQUIBASE_PROPS_FILE: ./liquibase.properties

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17
          java-package: jdk

      - name: Download and install Liquibase
        run: |
          curl -Lo liquibase.tar.gz https://github.com/liquibase/liquibase/releases/download/v4.25.1/liquibase-4.25.1.tar.gz
          rm -rf liquibase liquibase.tar.gz /usr/local/bin/liquibase
          tar -xzf liquibase.tar.gz
          chmod +x liquibase/liquibase
          sudo mv liquibase/liquibase /usr/local/bin/liquibase

      - name: Verify Liquibase installation
        run: |
          which liquibase
          liquibase --version

      - name: Dry run DDL/DML + sync changelog (first deploy)
        if: github.event.before == '0000000000000000000000000000000000000000'
        run: |
          echo "Running dry-run updateSQL"
          liquibase updateSQL
          echo "Syncing changelog"
          liquibase changelogSync

      - name: Run Liquibase update (subsequent commits)
        if: github.event.before != '0000000000000000000000000000000000000000'
        run: |
          echo "Applying changes via liquibase update"
          liquibase update
